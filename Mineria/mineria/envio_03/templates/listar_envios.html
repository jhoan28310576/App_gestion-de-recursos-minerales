{% extends 'base.html' %}

{% block title %}
  Lista de envios
{% endblock %}

{% block content %}
  <div>
    <iframe src="/static/grafico/mi_grafico_envio.html" width="90%" height="600"></iframe>
  </div>

  <div class="container" style="border: 1px solid #000; border-radius: 10px;">
    {% for envios in envio %}
      <div class="row border-bottom py-2 align-items-center">
        <div class="col">
          <p class="d-inline-block mb-0">{{ envios.mineral }}</p>
          <div class="d-inline-block float-end">
            <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#infoModal" data-id="{{ envios.id }}" onclick="loadMineralDetails({{ envios.id }})">Ver Información</button>

            <button type="button" class="btn btn-danger delete-btn" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal" data-id="{{ envios.id }}">Eliminar</button>
          </div>
        </div>
      </div>
      {% empty %}
      <p>No hay envios para mostrar.</p>
    {% endfor %}
  </div>

  <!-- Modal para mostrar información -->
  <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Información del envio</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="infoModalBody">
          <!-- Aquí se mostrará la información específica del mineral -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Modificar</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para confirmar eliminación -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar eliminación</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="deleteModalBody">
          ¿Estás seguro de que quieres eliminar este envio?<input type="hidden" id="csrf" name="csrfmiddlewaretoken" value="{{ csrf_token }}" />
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteButton">Eliminar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function loadMineralDetails(id) {
      $.ajax({
        url: '/envio/load_envio_details/',
        data: {
          id: id
        },
        dataType: 'json',
        success: function (data) {
          $('#infoModalBody').html('<p>mineral: ' + data.mineral + '</p><p>transporte: ' + data.transporte + '</p><p>destino: ' + data.destino + '</p><p>fecha_envio: ' + data.fecha_envio + '</p><p>cantidad_mineral: ' + data.cantidad_mineral + '</p>')
          $('#infoModal').modal('show')
        }
      })
    }
    
    // function para eliminar dsde aquipra abajo
    $(document).ready(function () {
      // Obtiene el token CSRF de las cookies
      var csrftoken = getCookie('csrftoken')
    
      $('.delete-btn').click(function () {
        var id = $(this).data('id') // Obtiene el id del botón de eliminar
        $('#confirmDeleteButton').data('id', id) // Guarda el id en el botón de confirmación
      })
    
      $('#confirmDeleteButton').click(function () {
        var id = $(this).data('id')
        confirmDelete(id)
      })
    
      function confirmDelete(id) {
        $.ajax({
          url: '/envio/delete_envio/' + id,
          type: 'DELETE',
          beforeSend: function (xhr) {
            xhr.setRequestHeader('X-CSRFToken', csrftoken)
          },
          success: function (result) {
            // Recarga la página o actualiza la lista de minerales
            location.reload()
          }
        })
      }
    
      // Función para obtener una cookie por su nombre
      function getCookie(name) {
        var cookieValue = null
        if (document.cookie && document.cookie !== '') {
          var cookies = document.cookie.split(';')
          for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i])
            // ¿El cookie comienza con el nombre que queremos?
            if (cookie.substring(0, name.length + 1) === name + '=') {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1))
              break
            }
          }
        }
        return cookieValue
      }
    
      $('#infoModal').on('hidden.bs.modal', function (e) {
        $.ajax({
          url: '/envio/listar',
          type: 'GET',
          success: function (result) {
            // Actualiza el HTML de tu página con la nueva lista de transportes
            $('#id_de_tu_lista_de_envio').html(result)
          }
        })
      })
    
      $('#confirmDeleteModal').on('show.bs.modal', function (e) {
        $('#deleteModalBody').html('¿Estás seguro de que quieres eliminar este envio?')
      })
    })
  </script>
{% endblock %}
